<!DOCTYPE html>
<html>
<body>
<script type="text/javascript">

var mapPaddings = [20, 20, 40, 20];
var showreelWidth = width - mapPaddings[1] - mapPaddings[3];
var showreelHeight = height - mapPaddings[0] - mapPaddings[2];

var x, y, duration = 1500, delay = 1000;

var color = d3.scale.ordinal().range(["#CA0020", "#F4A582", "#92C5DE", "#0571B0"]);

var svg = d3.select("#mainMap").append("svg:svg")
        .attr("width", width)
        .attr("height", height)
        .attr("id", "mainMapSVG")
        .on("click", animationClick)
        .append("svg:g")
        .attr("transform", "translate(" + mapPaddings[3] + "," + mapPaddings[0] + ")");

var houseprices, housetypes, showreelData;

var line = d3.svg.line()
        .interpolate("basis")
        .x(function(d) {
            return x(d.date);
        })
        .y(function(d) {
            return y(d.price);
        });

var axis = d3.svg.line()
        .interpolate("basis")
        .x(function(d) {
            return x(d.date);
        })
        .y(showreelHeight);

var area = d3.svg.area()
        .interpolate("basis")
        .x(function(d) {
            return x(d.date);
        })
        .y1(function(d) {
            return y(d.price);
        });

// set map variables selector
var housingTypes = [
    ["singlefamily", "Single Family"],
    ["condo", "Condo"],
    ["all", "All Home Prices"]
];
$("#mapControls").show();
$("#mapVariablesSelector").show();
d3.select("#mapVariablesSelector").append("select")
        .attr("id", "housingTypeSelect")
        .on("change", redrawShowReel)
        .selectAll("option")
        .data(housingTypes)
        .enter()
        .append("option")
        .attr("value", function(d) {
            return d[0];
        })
        .text(function(d) {
            return d[1];
        });

if (showreelFilename == "data/data_output_HP_Years_SingleFamilyHomes.csv") {
    $('#housingTypeSelect').val('singlefamily');
    $('#mainMapTitle').html("Price trends of Housing Prices by Region for Single Family Homes");
} else if (showreelFilename == "data/data_output_HP_Years_Condo.csv") {
    $('#housingTypeSelect').val('condo');
    $('#mainMapTitle').html("Price trends of Housing Prices by Region for Condos");
} else if (showreelFilename == "data/data_output_HP_Years_SFC.csv") {
    $('#housingTypeSelect').val('all');
    $('#mainMapTitle').html("Price trends of Housing Prices for Single Family Homes & Condos");
}

d3.csv(showreelFilename, function(data) {
    showreelData = data;
    setupShowreel();
});

function setupShowreel()
{
    var parse = d3.time.format("%b-%y").parse;

    housetypes = d3.nest()
            .key(function(d) {
                return d.housetype;
            })
            .entries(houseprices = showreelData);

    housetypes.forEach(function(s) {
        s.values.forEach(function(d) {
            d.date = parse(d.date);
            d.price = +d.price;
        });
        s.maxPrice = d3.max(s.values, function(d) {
            return d.price;
        });
        s.sumPrice = d3.sum(s.values, function(d) {
            return d.price;
        });
    });

    housetypes.sort(function(a, b) {
        return b.maxPrice - a.maxPrice;
    });

    var g = svg.selectAll("g")
            .data(housetypes)
            .enter().append("svg:g")
            .attr("class", "housetype");

    timer = new Timer(overlappingArea, duration);

}

function overlappingArea()
{

    x = d3.time.scale().range([0, showreelWidth - 60]);
    y = d3.scale.linear().range([showreelHeight / 4 - 20, 0]);

    x.domain([
        d3.min(housetypes, function(d) {
            return d.values[0].date;
        }),
        d3.max(housetypes, function(d) {
            return d.values[d.values.length - 1].date;
        })
    ]);

    var g = svg.selectAll(".housetype");

    g.each(function(d)
    {
        var e = d3.select(this);

        e.append("svg:text")
                .attr("x", 12)
                .attr("dy", ".4em")
                .text(d.key);
    });

    line.y(function(d) {
        return y(d.price0 + d.price);
    });

    g.select(".line")
            .attr("d", function(d) {
                return line(d.values);
            });

    y.domain([0, d3.max(housetypes.map(function(d) {
        return d.maxPrice;
    }))]).range([showreelHeight, 0]);

    var t = g.transition().duration(duration);

    t.select("text")
        .attr("dy", ".31em")
        .attr("transform", function(d) {
            d = d.values[d.values.length - 1];
            var yPosition = d.housetype == 'Condo' ? d.price - 10000 : d.price;
            return "translate(" + (showreelWidth - 60) + "," + y(yPosition) + ")";
        });

    svg.append("svg:line")
            .attr("class", "line")
            .attr("x1", 0)
            .attr("x2", showreelWidth - 60)
            .attr("y1", showreelHeight)
            .attr("y2", showreelHeight)
            .style("stroke-opacity", 1e-6)
            .transition()
            .duration(duration)
            .style("stroke-opacity", 1);

    timer = new Timer(groupedBar, duration + delay);
}

function groupedBar()
{
    x = d3.scale.ordinal()
            .domain(housetypes[0].values.map(function(d) {
        return d.date;
    })).rangeBands([0, showreelWidth - 60], .1);

    var x1 = d3.scale.ordinal()
        .domain(housetypes.map(function(d) {
            return d.key;
        })).rangeBands([0, x.rangeBand()]);

    var g = svg.selectAll(".housetype");

    var t = g.transition().duration(duration);

    t.select(".line")
        .style("stroke-opacity", 1e-6)
        .remove();

    t.select(".area")
        .style("fill-opacity", 1e-6)
        .remove();

    g.each(function(p, j) {
        d3.select(this).selectAll("rect")
            .data(function(d) {
                return d.values;
            })
            .enter().append("svg:rect")
            .attr("x", function(d) {
                return x(d.date) + x1(p.key);
            })
            .attr("y", function(d) {
                return y(d.price);
            })
            .attr("width", x1.rangeBand())
            .attr("height", function(d) {
                return showreelHeight - y(d.price);
            })
            .style("fill", color(p.key))
            .style("fill-opacity", 1e-6)
            .transition()
            .duration(duration)
            .style("fill-opacity", 1);
    });

    timer = new Timer(stackedBar, duration + delay);
}

function stackedBar()
{
    x.rangeRoundBands([0, showreelWidth - 60], .1);

    var stack = d3.layout.stack()
        .values(function(d) {
            return d.values;
        })
        .x(function(d) {
            return d.date;
        })
        .y(function(d) {
            return d.price;
        })
        .out(function(d, y0, y) {
            d.price0 = y0;
        })
        .order("reverse");

    var g = svg.selectAll(".housetype");

    stack(housetypes);

    y.domain([0, d3.max(housetypes[0].values.map(function(d) {
        return d.price + d.price0;
    }))]).range([showreelHeight, 0]);

    var t = g.transition().duration(duration / 2);

    t.select("text")
        .delay(housetypes[0].values.length * 10)
        .attr("transform", function(d) {
            d = d.values[d.values.length - 1];
            return "translate(" + (showreelWidth - 60) + "," + y(d.price / 2 + d.price0) + ")";
        });

    t.selectAll("rect")
        .delay(function(d, i) {
            return i * 10;
        })
        .attr("y", function(d) {
            return y(d.price0 + d.price);
        })
        .attr("height", function(d) {
            return showreelHeight - y(d.price);
        })
        .each("end", function() {
            d3.select(this)
                    .style("stroke", "#fff")
                    .style("stroke-opacity", 1e-6)
                    .transition()
                    .duration(duration / 2)
                    .attr("x", function(d) {
                        return x(d.date);
                    })
                    .attr("width", x.rangeBand())
                    .style("stroke-opacity", 1);
        });

    timer = new Timer(transposeBar, duration + delay);
}

function transposeBar()
{
    x.domain(housetypes.map(function(d) {
        return d.key;
    })).rangeRoundBands([0, showreelWidth], .2);

    y.domain([0, d3.max(housetypes.map(function(d) {
        return d3.sum(d.values.map(function(d) {
            return d.price;
        }));
    }))]);

    var stack = d3.layout.stack()
        .x(function(d, i) {
            return i;
        })
        .y(function(d) {
            return d.price;
        })
        .out(function(d, y0, y) {
            d.price0 = y0;
        });

    stack(d3.zip.apply(null, housetypes.map(function(d) {
        return d.values;
    })));

    var g = svg.selectAll(".housetype");

    var t = g.transition()
            .duration(duration / 2);

    t.selectAll("rect")
        .delay(function(d, i) {
            return i * 10;
        })
        .attr("y", function(d) {
            return y(d.price0 + d.price) - 1;
        })
        .attr("height", function(d) {
            return showreelHeight - y(d.price) + 1;
        })
        .attr("x", function(d) {
            return x(d.housetype);
        })
        .attr("width", x.rangeBand())
        .style("stroke-opacity", 1e-6);

    t.select("text")
        .attr("x", 0)
        .attr("transform", function(d) {
            return "translate(" + (x(d.key) + x.rangeBand() / 2) + "," + showreelHeight + ")";
        })
        .attr("dy", "1.31em")
        .each("end", function() {
            d3.select(this).attr("x", null).attr("text-anchor", "middle");
        });

    svg.select("line").transition()
            .duration(duration)
            .attr("x2", showreelWidth);

    timer = new Timer(donut, duration + delay);
}

function donut() {
    var g = svg.selectAll(".housetype");

    g.selectAll("rect").remove();

    var pie = d3.layout.pie()
            .value(function(d) {
                return d.sumPrice;
            });

    var arc = d3.svg.arc();

    g.append("svg:path")
            .style("fill", function(d) {
                return color(d.key);
            })
            .data(function() {
                return pie(housetypes);
            })
            .transition()
            .duration(duration)
            .tween("arc", arcTween);

    g.select("text").transition()
            .duration(duration)
            .attr("dy", ".31em");

    svg.select("line").transition()
            .duration(duration)
            .attr("y1", 2 * showreelHeight)
            .attr("y2", 2 * showreelHeight)
            .remove();

    function arcTween(d) {
        var path = d3.select(this), text = d3.select(this.parentNode.appendChild(this.previousSibling)), x0 = x(d.data.key), y0 = showreelHeight - y(d.data.sumPrice);

        return function(t) {
            var r = showreelHeight / 2 / Math.min(1, t + 1e-3), a = Math.cos(t * Math.PI / 2), xx = (-r + (a) * (x0 + x.rangeBand()) + (1 - a) * (showreelWidth + showreelHeight) / 2), yy = ((a) * showreelHeight + (1 - a) * showreelHeight / 2), f = {
                innerRadius: r - x.rangeBand() / (2 - a),
                outerRadius: r,
                startAngle: a * (Math.PI / 2 - y0 / r) + (1 - a) * d.startAngle,
                endAngle: a * (Math.PI / 2) + (1 - a) * d.endAngle
            };

            path.attr("transform", "translate(" + xx + "," + yy + ")");
            path.attr("d", arc(f));
            text.attr("transform", "translate(" + arc.centroid(f) + ")translate(" + xx + "," + yy + ")rotate(" + ((f.startAngle + f.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
        };
    }

    timer = new Timer(donutExplode, duration + delay);
}

function donutExplode() {
    var r0a = showreelHeight / 2 - x.rangeBand() / 2, r1a = showreelHeight / 2, r0b = 2 * showreelHeight - x.rangeBand() / 2, r1b = 2 * showreelHeight, arc = d3.svg.arc();

    svg.selectAll(".housetype path")
            .each(transitionExplode);

    function transitionExplode(d, i) {
        d.innerRadius = r0a;
        d.outerRadius = r1a;
        d3.select(this).transition()
                .duration(duration / 2)
                .tween("arc", tweenArc({
            innerRadius: r0b,
            outerRadius: r1b
        }));
    }

    function tweenArc(b) {
        return function(a) {
            var path = d3.select(this), text = d3.select(this.nextSibling), i = d3.interpolate(a, b);
            for (var key in b) a[key] = b[key]; // update data
            return function(t) {
                var a = i(t);
                path.attr("d", arc(a));
                text.attr("transform", "translate(" + arc.centroid(a) + ")translate(" + showreelWidth / 2 + "," + showreelHeight / 2 + ")rotate(" + ((a.startAngle + a.endAngle) / 2 + 3 * Math.PI / 2) * 180 / Math.PI + ")");
            };
        }
    }

    timer = new Timer(function() {
        svg.selectAll("*").remove();
        svg.selectAll("g").data(housetypes).enter().append("svg:g").attr("class", "housetype");
        overlappingArea();
    }, duration);

}
var animationPaused = false;

function animationClick(d)
{
    if (animationPaused) {
        timer.resume();
        animationPaused = false;
    } else {
        timer.pause();
        animationPaused = true;
    }
}


function Timer(callback, delay) {
    var timerId, start, remaining = delay;

    this.pause = function() {
        window.clearTimeout(timerId);
        remaining -= new Date() - start;
    };

    this.resume = function() {
        start = new Date();
        timerId = window.setTimeout(callback, remaining);
    };

    this.resume();
}

</script>
</body>
</html>
