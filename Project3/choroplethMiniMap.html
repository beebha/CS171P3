<!DOCTYPE html>
<html>
<body>
<script>
    // TODO - function to draw bars
    var radius = Math.min(miniWidth, miniHeight) / 2;

    var colors = ["#9ECAE1", "#3182BD"];

    var arc = d3.svg.arc()
            .outerRadius(radius - 10)
            .innerRadius(0);

    var countyData = d3.map(choroplethMiniMapsJSONData);

    // rental variables
    var totalRentalPercentage = 0;

    // house size variables
    var houseSize1BrPercentage  = 0;
    var houseSize2BrPercentage  = 0;
    var houseSize3BrPercentage  = 0;
    var houseSize4BrPercentage  = 0;
    var houseSize5BrMorePercentage  = 0;

    // county count
    var totalCountyCount = 0;

    countyData.forEach(function(d) {

        if (dataToShow == "state") {

            if (parseInt(stateClickedData.STATE_FIPS) == countyData.get(d).stateFIP)
            {
                // state data available for rental vs owner
                totalRentalPercentage += countyData.get(d)['occupant']['renterOcc%'];

                // state data available for house size
                houseSize1BrPercentage += countyData.get(d)['houseSize']['1Br%'];
                houseSize2BrPercentage += countyData.get(d)['houseSize']['2Br%'];
                houseSize3BrPercentage += countyData.get(d)['houseSize']['3Br%'];
                houseSize4BrPercentage += countyData.get(d)['houseSize']['4Br%'];
                houseSize5BrMorePercentage += countyData.get(d)['houseSize']['5BrMore%'];

                // increase county count
                totalCountyCount ++;
            }
        } else {
            if (parseInt(countyClickedData.FIPS) == parseInt(d))
            {
                // county data available for rental vs owner
                totalRentalPercentage = isNaN(countyData.get(d)['occupant']['renterOcc%']) ? 0 : countyData.get(d)['occupant']['renterOcc%'];

                // county data available for house size
                houseSize1BrPercentage = isNaN(countyData.get(d)['houseSize']['1Br%']) ? 0 : countyData.get(d)['houseSize']['1Br%'];
                houseSize2BrPercentage = isNaN(countyData.get(d)['houseSize']['2Br%']) ? 0 : countyData.get(d)['houseSize']['2Br%'];
                houseSize3BrPercentage = isNaN(countyData.get(d)['houseSize']['3Br%']) ? 0 : countyData.get(d)['houseSize']['3Br%'];
                houseSize4BrPercentage = isNaN(countyData.get(d)['houseSize']['4Br%']) ? 0 : countyData.get(d)['houseSize']['4Br%'];
                houseSize5BrMorePercentage = isNaN(countyData.get(d)['houseSize']['5BrMore%']) ? 0 : countyData.get(d)['houseSize']['5BrMore%'];

                totalCountyCount = 1;
            }
        }
    });

    // Rental vs Owner
    var rental = (totalRentalPercentage / totalCountyCount).toFixed(2);
    var owner = (100 - rental).toFixed(2);

    var choroplethMiniMap1Data = [];

    if(!isNaN(rental)) {
        choroplethMiniMap1Data = [
            {"label":"Rental: " + rental + "%", "value":rental},
            {"label":"Owner: " + owner + "%", "value":owner}
        ];
    }

    $('#miniMapTitle').html(dataToShow == "state" ? " for " + stateClickedData.STATE : " for " + countyClickedData.COUNTY);

    if(choroplethMiniMap1Data.length > 0)
    {
        $('#miniMap1Title').html("Occupancy Info");
        $('#miniMap1Title').css("margin-left", "8px");

        var pie = d3.layout.pie()
                .sort(null)
                .value(function(d) {
                    return d.value;
                });

        var miniMap1SVG = d3.select("#miniMap1")
                .append("svg")
                .attr("id", "miniMap1SVG")
                .attr("width", miniWidth)
                .attr("height", miniHeight)
                .data([choroplethMiniMap1Data])
                .append("g")
                .attr("transform", "translate(" + miniWidth / 2 + "," + miniHeight / 2 + ")");

        var arcs = miniMap1SVG.selectAll("g.slice")
                .data(pie)
                .enter()
                .append("svg:g")
                .attr("class", "slice");

        arcs.append("svg:path")
                .attr("fill", function(d, i) {
                    return colors[i];
                })
                .attr("d", arc);

        arcs.append("svg:text")
                .attr("transform", function(d) {
                    d.innerRadius = 0;
                    d.outerRadius = radius;
                    return "translate(" + arc.centroid(d) + ")";
                })
                .attr("text-anchor", "middle")
                .text(function(d, i) {
                    return choroplethMiniMap1Data[i].label;
                });
    } else {
        $('#miniMap1Title').html("");
    }


    // House size
    var houseSize1Br = (houseSize1BrPercentage / totalCountyCount).toFixed(2);
    var houseSize2Br = (houseSize2BrPercentage / totalCountyCount).toFixed(2);
    var houseSize3Br = (houseSize3BrPercentage / totalCountyCount).toFixed(2);
    var houseSize4Br = (houseSize4BrPercentage / totalCountyCount).toFixed(2);
    var houseSize5BrMore = (houseSize5BrMorePercentage / totalCountyCount).toFixed(2);


    var choroplethMiniMap2Data = [];

    if(!isNaN(houseSize1Br)) {
        choroplethMiniMap2Data = [
            {"label":"1 Br", "value":houseSize1Br},
            {"label":"2 Br", "value":houseSize2Br},
            {"label":"3 Br", "value":houseSize3Br},
            {"label":"4 Br", "value":houseSize4Br},
            {"label":"5 Br And More", "value":houseSize5BrMore}
        ];
    }

    if(choroplethMiniMap2Data.length > 0)
    {

        $('#miniMap2Title').html("Housing Size Info");

        var valueLabelWidth = 40; // space reserved for value labels (right)
        var barHeight = 20; // height of one bar
        var barLabelWidth = 110; // space reserved for bar labels
        var barLabelPadding = 5; // padding between bar and bar labels (left)
        var gridLabelHeight = 18; // space reserved for gridline labels
        var gridChartOffset = 3; // space between start of grid and first bar
        var maxBarWidth = 25; // width of the bar with the max value

        // accessor functions
        var barLabel = function(d) { return d.label; };
        var barValue = function(d) { return d.value; };

        var yScale = d3.scale.ordinal().domain(d3.range(0, choroplethMiniMap2Data.length)).rangeBands([0, choroplethMiniMap2Data.length * barHeight]);
        var y = function(d, i) { return yScale(i); };
        var yText = function(d, i) { return y(d, i) + yScale.rangeBand() / 2; };
        var x = d3.scale.linear().domain([0, d3.max(choroplethMiniMap2Data, barValue)]).range([0, maxBarWidth]);

        var miniMap2SVG = d3.select("#miniMap2")
                .append("svg")
                .attr("id", "miniMap2SVG")
                .attr('width', 350)
                .attr('height', miniHeight);

        // grid line labels
        var gridContainer = miniMap2SVG.append('g')
                .attr('transform', 'translate(' + barLabelWidth + ',' + gridLabelHeight + ')');

        // bar labels
        var labelsContainer = miniMap2SVG.append('g')
                .attr('transform', 'translate(' + (barLabelWidth - barLabelPadding) + ',' + (gridLabelHeight + gridChartOffset) + ')');
        labelsContainer.selectAll('text').data(choroplethMiniMap2Data).enter().append('text')
                .attr('y', yText)
                .attr('stroke', 'none')
                .attr('fill', 'black')
                .attr("dy", ".15em")
                .attr("font-size", "11")
                .attr('text-anchor', 'end')
                .text(barLabel);
        // bars
        var barsContainer = miniMap2SVG.append('g')
                .attr('transform', 'translate(' + barLabelWidth + ',' + (gridLabelHeight + gridChartOffset) + ')');
        barsContainer.selectAll("rect").data(choroplethMiniMap2Data).enter().append("rect")
                .attr('y', y)
                .attr('height', yScale.rangeBand())
                .attr('width', function(d) {
                    return x(barValue(d));
                })
                .attr('stroke', 'white')
                .attr('fill', '#1B9E77');
        // bar value labels
        barsContainer.selectAll("text").data(choroplethMiniMap2Data).enter().append("text")
                .attr("x", function(d) {
                    return x(barValue(d));
                })
                .attr("y", yText)
                .attr("dx", 3)
                .attr("dy", ".15em")
                .attr("font-size", "11")
                .attr("text-anchor", "start")
                .attr("fill", "black")
                .attr("stroke", "none")
                .text(function(d) {
                    return d3.round(barValue(d), 2);
                });
        // start line
        barsContainer.append("line")
                .attr("y1", -gridChartOffset)
                .attr("y2", yScale.rangeExtent()[1] + gridChartOffset)
                .style("stroke", "#000");


    } else {
        $('#miniMap2Title').html("");
    }

</script>
</body>
</html>